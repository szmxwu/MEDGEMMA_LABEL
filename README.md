# MedGemma X-ray Labeling System

åŸºäº MedGemma-1.5-4B-IT å¤šæ¨¡æ€å¤§è¯­è¨€æ¨¡å‹çš„åŒ»å­¦Xå…‰å½±åƒè‡ªåŠ¨æ ‡æ³¨ç³»ç»Ÿï¼Œæ”¯æŒéƒ¨ä½è¯†åˆ«ã€æ–¹ä½åˆ¤æ–­å’Œæ‹æ‘„ä½“ä½åˆ†ç±»ï¼Œå¹¶æä¾›äº¤äº’å¼Webç•Œé¢ä¾›äººå·¥å¤æ ¸ã€‚

## åŠŸèƒ½ç‰¹æ€§

### ğŸ¤– è‡ªåŠ¨æ ‡æ³¨
- **éƒ¨ä½è¯†åˆ«**: è‡ªåŠ¨è¯†åˆ«Xå…‰å½±åƒçš„èº«ä½“éƒ¨ä½ï¼ˆé¢ˆæ¤ã€è…°æ¤ã€è†å…³èŠ‚ç­‰25+éƒ¨ä½ï¼‰
- **æ–¹ä½åˆ¤æ–­**: è¯†åˆ«å·¦å³æ–¹ä½ï¼ˆleft/right/bilateralï¼‰
- **ä½“ä½åˆ†ç±»**: è¯†åˆ«æ‹æ‘„ä½“ä½ï¼ˆfrontal/lateral/oblique/axial/specialï¼‰
- **æ™ºèƒ½åŒ¹é…**: ä½¿ç”¨æ”¹è¿›çš„è´ªå¿ƒç®—æ³•è¿›è¡Œå¤šå›¾å¤šæ ‡ç­¾çš„å…¨å±€æœ€ä¼˜åŒ¹é…
- **ç½®ä¿¡åº¦è¯„ä¼°**: ä¸ºæ¯ä¸ªé¢„æµ‹ç»“æœè®¡ç®—ç½®ä¿¡åº¦ï¼Œæ ‡è®°ä½ç½®ä¿¡åº¦æ ·æœ¬ä¾›å¤æ ¸

### ğŸ–¥ï¸ Webå¤æ ¸ç•Œé¢
- **åˆ†é¡µæ˜¾ç¤º**: æ”¯æŒæ¯é¡µ5/10/20/50æ¡æ ·æœ¬
- **å®æ—¶ä¿®æ”¹**: æ”¯æŒä¿®æ”¹æ–¹ä½å’Œä½“ä½æ ‡ç­¾
- **è‡ªåŠ¨ä¿å­˜**: ä¿®æ”¹åè‡ªåŠ¨ä¿å­˜ï¼Œæ— éœ€æ‰‹åŠ¨ç‚¹å‡»ä¿å­˜æŒ‰é’®
- **ç­›é€‰åŠŸèƒ½**: æŒ‰éƒ¨ä½å’Œå¤æ ¸çŠ¶æ€ç­›é€‰æ ·æœ¬
- **å¯¼å‡ºç»“æœ**: å¯¼å‡ºJSONæ ¼å¼çš„ä¿®æ”¹è®°å½•
- **ç¦»çº¿è¿è¡Œ**: æ‰€æœ‰é™æ€èµ„æºå·²æœ¬åœ°åŒ–ï¼Œæ— éœ€å¤–ç½‘

### âš¡ é«˜æ•ˆå¤„ç†
- **å¤šçº¿ç¨‹å¹¶å‘**: æ”¯æŒå¤šçº¿ç¨‹å¹¶è¡Œå¤„ç†ï¼Œæé«˜æ•ˆç‡
- **é”™è¯¯é‡è¯•**: APIè°ƒç”¨å¤±è´¥è‡ªåŠ¨é‡è¯•
- **è¿›åº¦æ˜¾ç¤º**: å®æ—¶æ˜¾ç¤ºå¤„ç†è¿›åº¦å’Œé¢„ä¼°æ—¶é—´
- **ç»“æ„åŒ–æ—¥å¿—**: å®Œæ•´çš„æ—¥å¿—è®°å½•ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜

## å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

ä¸»è¦ä¾èµ–ï¼š
- pandas >= 2.0.0
- numpy >= 1.24.0
- requests >= 2.31.0
- scipy >= 1.11.0
- flask >= 3.0.0
- openpyxl >= 3.1.0

## å¿«é€Ÿå¼€å§‹

### æ–¹å¼ä¸€ï¼šå®Œæ•´æµæ°´çº¿ï¼ˆæ¨èï¼‰

ä¸€é”®å®Œæˆæ ‡æ³¨å’Œå¤æ ¸æœåŠ¡å¯åŠ¨ï¼š

```bash
python run_pipeline.py --workers 4
```

æµè§ˆå™¨å°†è‡ªåŠ¨æ‰“å¼€ http://localhost:5000 è¿›å…¥å¤æ ¸ç•Œé¢ã€‚

### æ–¹å¼äºŒï¼šåˆ†æ­¥æ‰§è¡Œ

#### 1. è¿è¡ŒLLMæ ‡æ³¨

```bash
python LLM_lable.py --workers 4
```

è¾“å‡ºæ–‡ä»¶ï¼š`processed_labels_v3.xlsx`

#### 2. å¯åŠ¨å¤æ ¸WebæœåŠ¡

```bash
python web/app.py --port 5000
```

è®¿é—® http://localhost:5000 è¿›è¡Œäººå·¥å¤æ ¸ã€‚

### æ–¹å¼ä¸‰ï¼šä»…å¯åŠ¨å¤æ ¸æœåŠ¡

å¦‚æœå·²å®Œæˆæ ‡æ³¨ï¼Œåªæƒ³å¯åŠ¨å¤æ ¸æœåŠ¡ï¼š

```bash
python run_pipeline.py --review-only --port 5000
```

## é¡¹ç›®ç»“æ„

```
Medgemma_label/
â”‚
â”œâ”€â”€ æ ¸å¿ƒæ¨¡å—/
â”‚   â”œâ”€â”€ LLM_lable.py              # ä¸»ç¨‹åº - LLMæ ‡æ³¨
â”‚   â”œâ”€â”€ projection_matcher.py     # æŠ•å½±åŒ¹é…ç®—æ³•
â”‚   â”œâ”€â”€ run_pipeline.py           # å®Œæ•´æµæ°´çº¿è„šæœ¬
â”‚   â””â”€â”€ medgamma_test.py          # APIæµ‹è¯•è„šæœ¬
â”‚
â”œâ”€â”€ WebæœåŠ¡/
â”‚   â””â”€â”€ web/
â”‚       â”œâ”€â”€ app.py                # Flaskåº”ç”¨
â”‚       â”œâ”€â”€ templates/
â”‚       â”‚   â””â”€â”€ review.html       # å¤æ ¸é¡µé¢æ¨¡æ¿
â”‚       â””â”€â”€ static/               # é™æ€èµ„æºï¼ˆå·²æœ¬åœ°åŒ–ï¼‰
â”‚           â”œâ”€â”€ css/              # Bootstrap + Font Awesome
â”‚           â”œâ”€â”€ js/               # Bootstrap JS
â”‚           â”œâ”€â”€ webfonts/         # å­—ä½“æ–‡ä»¶
â”‚           â””â”€â”€ images/           # å ä½å›¾ç‰‡
â”‚
â”œâ”€â”€ æ•°æ®/
â”‚   â”œâ”€â”€ data/                     # Xå…‰å›¾ç‰‡ç›®å½•
â”‚   â”‚   â””â”€â”€ {å½±åƒå·}/             # æŒ‰å½±åƒå·ç»„ç»‡çš„æ–‡ä»¶å¤¹
â”‚   â”‚       â”œâ”€â”€ *.png             # Xå…‰å›¾ç‰‡
â”‚   â”‚       â””â”€â”€ dicom_metadata_*.xlsx
â”‚   â”œâ”€â”€ selected_samples.xlsx     # æ ·æœ¬åˆ—è¡¨
â”‚   â””â”€â”€ part_exam_orientation.json # éƒ¨ä½é…ç½®
â”‚
â”œâ”€â”€ è¾“å‡º/
â”‚   â”œâ”€â”€ processed_labels_v3.xlsx  # æ ‡æ³¨ç»“æœ
â”‚   â””â”€â”€ logs/                     # æ—¥å¿—æ–‡ä»¶
â”‚
â”œâ”€â”€ README.md                     # æœ¬æ–‡ä»¶
â”œâ”€â”€ requirements.txt              # Pythonä¾èµ–
â””â”€â”€ AGENTS.md                     # é¡¹ç›®èƒŒæ™¯è¯´æ˜
```

## ä½¿ç”¨è¯´æ˜

### 1. å‡†å¤‡æ•°æ®

å°†Xå…‰å›¾ç‰‡æ”¾å…¥ `data/{å½±åƒå·}/` ç›®å½•ï¼Œç¡®ä¿ï¼š
- å›¾ç‰‡æ ¼å¼ä¸º PNG
- æ–‡ä»¶åä¸ `selected_samples.xlsx` ä¸­çš„è®°å½•å¯¹åº”

### 2. é…ç½®API

åœ¨ `LLM_lable.py` ä¸­é…ç½®APIä¿¡æ¯ï¼š

```python
BASE_URL = "https://smartlab.cse.ust.hk/smartcare/api/shebd/medgemma15"
API_URL = f"{BASE_URL}/v1/chat/completions"
MODEL_ID = "/data/shebd/0_Pretrained/medgemma-1.5-4b-it"
```

### 3. è¿è¡Œæ ‡æ³¨

```bash
# åŸºç¡€ç”¨æ³•
python LLM_lable.py

# å¤šçº¿ç¨‹ï¼ˆæ¨èï¼‰
python LLM_lable.py --workers 4

# é™åˆ¶æµ‹è¯•æ ·æœ¬æ•°
python LLM_lable.py --limit 10

# æ ‡æ³¨å®Œæˆåè‡ªåŠ¨å¯åŠ¨å¤æ ¸æœåŠ¡
python LLM_lable.py --workers 4 --review
```

### 4. äººå·¥å¤æ ¸

è®¿é—® http://localhost:5000 è¿›å…¥å¤æ ¸ç•Œé¢ï¼š

**ç•Œé¢æ“ä½œï¼š**
1. **æµè§ˆæ ·æœ¬**: ä½¿ç”¨åˆ†é¡µæ§ä»¶æˆ–æ»šåŠ¨æµè§ˆ
2. **ç­›é€‰æ ·æœ¬**: ä½¿ç”¨é¡¶éƒ¨ç­›é€‰å™¨æŒ‰éƒ¨ä½/çŠ¶æ€ç­›é€‰
3. **ä¿®æ”¹æ ‡ç­¾**:
   - æ–¹ä½(Orientation): é€‰æ‹© left/right/bilateral/Not Applicable
   - ä½“ä½(Projection): æ ¹æ®éƒ¨ä½æ˜¾ç¤ºä¸åŒé€‰é¡¹
     - Breast/ä¹³æˆ¿: cephalocaudal, spot compression, mediolateral oblique
     - å…¶ä»–: frontal, lateral, oblique, axial, special
4. **è‡ªåŠ¨ä¿å­˜**: ä¿®æ”¹åè‡ªåŠ¨ä¿å­˜ï¼Œæ˜¾ç¤º"âœ“ å·²ä¿å­˜"
5. **å¯¼å‡ºç»“æœ**: ç‚¹å‡»"å¯¼å‡ºç»“æœ"æŒ‰é’®ä¸‹è½½JSONæ–‡ä»¶

## å‘½ä»¤è¡Œå‚æ•°

### LLM_lable.py

```
--workers         å¹¶å‘çº¿ç¨‹æ•° (é»˜è®¤: 4)
--limit           é™åˆ¶å¤„ç†çš„æ ·æœ¬æ•°
--single          ä½¿ç”¨å•çº¿ç¨‹æ¨¡å¼
--confidence      ç½®ä¿¡åº¦é˜ˆå€¼ (é»˜è®¤: 0.6)
--review          æ ‡æ³¨å®Œæˆåè‡ªåŠ¨å¯åŠ¨å¤æ ¸æœåŠ¡
--review-port     å¤æ ¸æœåŠ¡ç«¯å£ (é»˜è®¤: 5000)
--no-open         ä¸è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨
--review-only     ä»…å¯åŠ¨å¤æ ¸æœåŠ¡ï¼Œä¸è¿è¡Œæ ‡æ³¨
```

### run_pipeline.py

```
--workers, -w     æ ‡æ³¨çº¿ç¨‹æ•° (é»˜è®¤: 4)
--limit, -l       é™åˆ¶æ ‡æ³¨æ ·æœ¬æ•°
--port, -p        WebæœåŠ¡å™¨ç«¯å£ (é»˜è®¤: 5000)
--no-open         ä¸è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨
--review-only     ä»…å¯åŠ¨å¤æ ¸æœåŠ¡å™¨
```

## è¾“å‡ºæ–‡ä»¶

### processed_labels_v3.xlsx

åŒ…å«å­—æ®µï¼š
- `image_id`: å½±åƒå·
- `filename`: å›¾ç‰‡æ–‡ä»¶å
- `original_part`: åŸå§‹éƒ¨ä½
- `final_body_part`: è¯†åˆ«çš„èº«ä½“éƒ¨ä½
- `final_orientation`: è¯†åˆ«çš„æ–¹ä½
- `final_projection`: è¯†åˆ«çš„ä½“ä½
- `confidence_projection`: ä½“ä½ç½®ä¿¡åº¦ (0-1)
- `confidence_orientation`: æ–¹ä½ç½®ä¿¡åº¦ (0-1)
- `confidence_overall`: ç»¼åˆç½®ä¿¡åº¦ (0-1)
- `needs_review`: æ˜¯å¦éœ€è¦äººå·¥å®¡æ ¸
- `review_reason`: éœ€è¦å®¡æ ¸çš„åŸå› 
- `match_method`: åŒ¹é…æ–¹æ³•

### web/outputs/review_modifications.json

Webå¤æ ¸ç•Œé¢ä¿å­˜çš„ä¿®æ”¹è®°å½•ã€‚

## æ•…éšœæ’é™¤

### APIè¿æ¥å¤±è´¥
```bash
# æµ‹è¯•APIè¿é€šæ€§
python medgamma_test.py
```

### å›¾ç‰‡æ— æ³•æ˜¾ç¤º
1. æ£€æŸ¥ `data/{å½±åƒå·}/` ç›®å½•ä¸‹æ˜¯å¦å­˜åœ¨å¯¹åº”å›¾ç‰‡
2. ç¡®è®¤å›¾ç‰‡æ ¼å¼ä¸º PNG
3. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯ä¿¡æ¯

### WebæœåŠ¡å¯åŠ¨å¤±è´¥
1. æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨ï¼š`lsof -i :5000`
2. æ£€æŸ¥Pythonä¾èµ–æ˜¯å¦å®‰è£…å®Œæ•´ï¼š`pip install -r requirements.txt`
3. æ£€æŸ¥ `web/app.py` æ˜¯å¦å­˜åœ¨

### ä¿®æ”¹æœªä¿å­˜
1. ç¡®è®¤æµè§ˆå™¨æ”¯æŒ localStorage
2. æ£€æŸ¥æµè§ˆå™¨å­˜å‚¨ç©ºé—´æ˜¯å¦å·²æ»¡
3. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯ä¿¡æ¯

## æµè§ˆå™¨æ”¯æŒ

- Chrome 80+
- Firefox 75+
- Safari 13+
- Edge 80+

ç§»åŠ¨ç«¯æµè§ˆå™¨åŒæ ·æ”¯æŒå“åº”å¼å¸ƒå±€ã€‚

## æŠ€æœ¯æ ˆ

- **Python 3.8+**
- **Flask**: Webæ¡†æ¶
- **Bootstrap 5**: UIç»„ä»¶
- **Font Awesome**: å›¾æ ‡
- **Pandas**: æ•°æ®å¤„ç†
- **NumPy/SciPy**: æ•°å€¼è®¡ç®—

## æ—¥å¿—æ–‡ä»¶

- `logs/processing_YYYYMMDD_HHMMSS.log`: å¤„ç†æ—¥å¿—
- `failed_samples_YYYYMMDD_HHMMSS.json`: å¤±è´¥æ ·æœ¬è®°å½•

## è®¸å¯è¯

æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨ã€‚

## è‡´è°¢

- åŸºäº Google MedGemma-1.5-4B-IT æ¨¡å‹
- é™æ€èµ„æºæ¥è‡ª Bootstrap å’Œ Font Awesome
